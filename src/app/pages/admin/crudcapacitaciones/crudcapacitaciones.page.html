<!-- crudcapacitaciones.page.html -->
<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Gestión de Capacitaciones</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-card class="main-card">
    <div class="logo-container ion-text-center">
      <img src="../../../../assets/cnc.png" alt="Logo Capacitaciones" class="logo">
    </div>

    <!-- Buscador y filtros -->
    <ion-card-content>
      <div class="search-section fade-in">
        <h3 class="section-title">Administración de Capacitaciones</h3>
        <div class="search-container">
          <ion-item class="search-item">
            <ion-icon name="search-outline" slot="start" color="primary"></ion-icon>
            <ion-input placeholder="Buscar por nombre o descripción" [(ngModel)]="terminoBusqueda" (ionChange)="aplicarFiltros()"></ion-input>
            <ion-button slot="end" fill="clear" (click)="aplicarFiltros()">
              <ion-icon name="search"></ion-icon>
            </ion-button>
          </ion-item>

          <div class="filter-container">
            <ion-item class="filter-item">
              <ion-icon name="filter-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Estado</ion-label>
              <ion-select [(ngModel)]="filtroEstado" (ionChange)="aplicarFiltros()" interface="action-sheet">
                <ion-select-option value="todos">Todos</ion-select-option>
                <ion-select-option value="0">Pendientes</ion-select-option>
                <ion-select-option value="1">Realizadas</ion-select-option>
                <ion-select-option value="2">Canceladas</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="filter-item">
              <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Ordenar por</ion-label>
              <ion-select [(ngModel)]="ordenarPor" (ionChange)="aplicarFiltros()" interface="action-sheet">
                <ion-select-option value="fecha_asc">Fecha (más antigua)</ion-select-option>
                <ion-select-option value="fecha_desc">Fecha (más reciente)</ion-select-option>
                <ion-select-option value="nombre">Nombre</ion-select-option>
              </ion-select>
            </ion-item>
          </div>
        </div>

        <!-- Botón para crear nueva capacitación -->
        <ion-button expand="block" color="primary" (click)="iraCrearCapacitacion()" class="create-button">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Crear Nueva Capacitación
        </ion-button>
      </div>

      <!-- Estadísticas -->
      <div class="stats-section fade-in" style="animation-delay: 0.1s;">
        <h3 class="section-title">Estadísticas</h3>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="calendar" color="primary"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ obtenerCapacitacionesPendientes() }}</span>
              <span class="stat-label">Pendientes</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ obtenerCapacitacionesRealizadas() }}</span>
              <span class="stat-label">Realizadas</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="document-text" color="tertiary"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ obtenerCertificadosEmitidos() }}</span>
              <span class="stat-label">Certificados</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de capacitaciones -->
      <div class="capacitaciones-section fade-in" style="animation-delay: 0.2s;">
        <div class="section-header">
          <h3 class="section-title">Listado de Capacitaciones</h3>
          <span class="results-count">{{ capacitacionesFiltradas.length }} registros</span>
        </div>

        <div *ngIf="capacitacionesFiltradas.length === 0" class="empty-state">
          <ion-icon name="alert-circle-outline" color="medium"></ion-icon>
          <h4>No hay capacitaciones disponibles</h4>
          <p>No se encontraron capacitaciones que coincidan con los criterios de búsqueda.</p>
          <ion-button expand="block" color="primary" (click)="limpiarFiltros()">
            Mostrar todas las capacitaciones
          </ion-button>
        </div>

        <div class="capacitaciones-grid" *ngIf="capacitacionesFiltradas.length > 0">
          <div class="capacitacion-card" *ngFor="let capacitacion of capacitacionesFiltradas"
               [ngClass]="{'pending-card': capacitacion.Estado === 0,
                           'completed-card': capacitacion.Estado === 1,
                           'canceled-card': capacitacion.Estado === 2}">
            <div class="capacitacion-header">
              <div class="capacitacion-title">
                <h4>{{ capacitacion.Nombre_Capacitacion }}</h4>
                <span class="capacitacion-badge"
                      [ngClass]="{'badge-pending': capacitacion.Estado === 0,
                                  'badge-completed': capacitacion.Estado === 1,
                                  'badge-canceled': capacitacion.Estado === 2}">
                  {{ getEstadoTexto(capacitacion.Estado) }}
                </span>
                <span *ngIf="capacitacion.Certificado" class="capacitacion-badge badge-certificate">
                  <ion-icon name="ribbon-outline"></ion-icon> Certificada
                </span>
              </div>
            </div>

            <div class="capacitacion-content">
              <p class="capacitacion-description">{{ capacitacion.Descripcion_Capacitacion }}</p>

              <div class="capacitacion-details">
                <div class="detail-item">
                  <ion-icon name="location" color="primary"></ion-icon>
                  <span>{{ capacitacion.Lugar_Capacitacion }}</span>
                </div>

                <div class="detail-item">
                  <ion-icon name="calendar" color="primary"></ion-icon>
                  <span>{{ capacitacion.Fecha_Capacitacion | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>

                <div class="detail-item">
                  <ion-icon name="laptop-outline" color="primary"></ion-icon>
                  <span>{{ capacitacion.Modalidades }}</span>
                </div>

                <div class="detail-item">
                  <ion-icon name="time" color="primary"></ion-icon>
                  <span>{{ capacitacion.Horas }} horas</span>
                </div>

                <div class="detail-item">
                  <ion-icon name="people" color="primary"></ion-icon>
                  <span>{{ capacitacion.Limite_Participantes }} participantes máx.</span>
                </div>
              </div>
            </div>

            <div class="capacitacion-actions">
              <ion-button fill="clear" color="primary" (click)="iraVisualizarinscritos(capacitacion.Id_Capacitacion)">
                <ion-icon name="people-outline"></ion-icon>
                Participantes
              </ion-button>

              <ion-button fill="clear" color="success" (click)="iraEditarCapacitacion(capacitacion.Id_Capacitacion)">
                <ion-icon name="create-outline"></ion-icon>
                Editar
              </ion-button>

              <ion-button fill="clear" color="danger" (click)="confirmarEliminar(capacitacion.Id_Capacitacion)">
                <ion-icon name="trash-outline"></ion-icon>
                Eliminar
              </ion-button>
            </div>

            <!-- Botones adicionales según el estado -->
            <div class="capacitacion-extra-actions" *ngIf="capacitacion.Estado === 0">
              <ion-button expand="block" color="success" (click)="finalizarCapacitacion(capacitacion.Id_Capacitacion)">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Finalizar Capacitación
              </ion-button>
            </div>

            <div class="capacitacion-extra-actions" *ngIf="capacitacion.Estado === 1 && !capacitacion.Certificado">
              <ion-button expand="block" color="warning" (click)="mostrarConfirmacion(capacitacion.Id_Capacitacion)">
                <ion-icon name="ribbon-outline" slot="start"></ion-icon>
                Emitir Certificados
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
