<!-- editar.page.html - Updated with location selectors -->
<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/ver-perfil"></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Editar Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div *ngIf="cargando" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando datos...</p>
  </div>

  <ion-card *ngIf="!cargando && usuario" class="edit-card">
    <ion-card-header>
      <div class="user-image-container">
        <ion-avatar>
          <img [src]="usuario.Imagen_Perfil || 'assets/avatar-placeholder.png'" alt="Foto de perfil">
        </ion-avatar>
        <div class="edit-photo-button" (click)="actualizarFotoPerfil()">
          <ion-icon name="camera"></ion-icon>
        </div>
      </div>
      <ion-card-title class="ion-text-center">{{ perfilForm.get('nombre')?.value }} {{ perfilForm.get('apellido')?.value }}</ion-card-title>
      <ion-card-subtitle class="ion-text-center">{{ perfilForm.get('email')?.value }}</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <form [formGroup]="perfilForm" (ngSubmit)="guardarCambios()">
        <div class="form-section">
          <h3 class="section-title">Información Personal</h3>

          <ion-item>
            <ion-label position="stacked">Nombre Completo <ion-text color="danger">*</ion-text></ion-label>
            <ion-input type="text" formControlName="nombre" placeholder="Ingrese su nombre"></ion-input>
            <ion-note slot="error" *ngIf="perfilForm.get('nombre')?.touched && perfilForm.get('nombre')?.hasError('required')">
              El nombre Completo es obligatorio
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Cédula <ion-text color="danger">*</ion-text></ion-label>
            <ion-input type="text" formControlName="cedula" placeholder="Ingrese su cédula" [readonly]="true"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Teléfono</ion-label>
            <ion-input type="tel" formControlName="telefono" placeholder="Ingrese su teléfono"></ion-input>
            <ion-note slot="error" *ngIf="perfilForm.get('telefono')?.touched && perfilForm.get('telefono')?.hasError('pattern')">
              Ingrese un número de teléfono válido de 10 dígitos
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Género</ion-label>
            <ion-select formControlName="genero" placeholder="Seleccione su género">
              <ion-select-option value="Masculino">Masculino</ion-select-option>
              <ion-select-option value="Femenino">Femenino</ion-select-option>
              <ion-select-option value="Otro">Otro</ion-select-option>
              <ion-select-option value="Prefiero no decir">Prefiero no decir</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nacionalidad</ion-label>
            <ion-input type="text" formControlName="nacionalidad" placeholder="Ingrese su nacionalidad"></ion-input>
          </ion-item>
        </div>

        <div class="form-section">
          <h3 class="section-title">Ubicación y Contacto</h3>

          <ion-item>
            <ion-label position="stacked">Correo Electrónico <ion-text color="danger">*</ion-text></ion-label>
            <ion-input type="email" formControlName="email" placeholder="Ingrese su correo electrónico" [readonly]="true"></ion-input>
          </ion-item>

          <!-- Selectores de ubicación -->
          <ion-item>
            <ion-label position="stacked">Provincia</ion-label>
            <ion-select formControlName="provincia" placeholder="Seleccione su provincia">
              <ion-select-option *ngFor="let provincia of provincias" [value]="provincia.Codigo_Provincia">
                {{ provincia.Nombre_Provincia }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Cantón</ion-label>
            <ion-select formControlName="canton" placeholder="Seleccione su cantón" [disabled]="!perfilForm.get('provincia')?.value">
              <ion-select-option *ngFor="let canton of cantones" [value]="canton.codigo_canton">
                {{ canton.nombre_canton }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Parroquia</ion-label>
            <ion-select formControlName="parroquia" placeholder="Seleccione su parroquia" [disabled]="!perfilForm.get('canton')?.value">
              <ion-select-option *ngFor="let parroquia of parroquias" [value]="parroquia.codigo_parroquia">
                {{ parroquia.nombre_parroquia }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="form-actions">
          <ion-button expand="block" type="submit" [disabled]="perfilForm.invalid || guardando" color="primary">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
          </ion-button>
          <ion-button expand="block" type="button" color="medium" (click)="cancelar()">
            <ion-icon name="close-outline" slot="start"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Estado vacío si no hay datos -->
  <div *ngIf="!cargando && !usuario" class="empty-state">
    <ion-icon name="alert-circle-outline" color="medium"></ion-icon>
    <h4>No se pudieron cargar los datos</h4>
    <p>No se encontró información del usuario para editar.</p>
    <ion-button expand="block" color="primary" (click)="volver()">
      Volver al perfil
    </ion-button>
  </div>
</ion-content>
