<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/gestionar-capacitaciones"></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Crear Nueva Capacitación</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-card class="main-card">
    <div class="logo-container ion-text-center">
      <img src="../../../../assets/cnc.png" alt="Logo Capacitaciones" class="logo">
    </div>

    <ion-card-content>
      <div class="form-header fade-in">
        <ion-icon name="calendar-outline" color="primary"></ion-icon>
        <h2>Nueva Capacitación</h2>
        <p>Complete todos los campos para crear una nueva capacitación</p>
      </div>

      <div class="progress-section fade-in">
        <div class="progress-container">
          <div class="progress-bar" [style.width]="calcularProgresoFormulario() + '%'"></div>
        </div>
        <div class="progress-label">
          Progreso: {{ calcularProgresoFormulario() }}%
        </div>
      </div>

      <form (ngSubmit)="crearCapacitacion()" #capacitacionForm="ngForm" class="fade-in" style="animation-delay: 0.1s;">
        <!-- Sección de Información Básica -->
        <div class="form-section">
          <h3 class="section-title">
            <ion-icon name="information-circle-outline"></ion-icon>
            Información Básica
          </h3>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="text-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Nombre de la Capacitación <ion-text color="danger">*</ion-text></ion-label>
              <ion-input [(ngModel)]="capacitacion.Nombre_Capacitacion" name="Nombre_Capacitacion" required #nombre="ngModel"></ion-input>
            </ion-item>
            <ion-note color="danger" *ngIf="nombre.invalid && (nombre.dirty || nombre.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              El nombre es obligatorio
            </ion-note>
          </div>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Descripción <ion-text color="danger">*</ion-text></ion-label>
              <ion-textarea [(ngModel)]="capacitacion.Descripcion_Capacitacion" name="Descripcion_Capacitacion" required rows="4" #descripcion="ngModel"></ion-textarea>
            </ion-item>
            <ion-note color="danger" *ngIf="descripcion.invalid && (descripcion.dirty || descripcion.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              La descripción es obligatoria
            </ion-note>
          </div>
        </div>

        <!-- Sección de Logística -->
        <div class="form-section">
          <h3 class="section-title">
            <ion-icon name="calendar-outline"></ion-icon>
            Logística
          </h3>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Fecha <ion-text color="danger">*</ion-text></ion-label>
              <ion-datetime displayFormat="DD/MM/YYYY" presentation="date" [(ngModel)]="capacitacion.Fecha_Capacitacion" name="Fecha_Capacitacion" required #fecha="ngModel"></ion-datetime>
            </ion-item>
            <ion-note color="danger" *ngIf="fecha.invalid && (fecha.dirty || fecha.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              La fecha es obligatoria
            </ion-note>
          </div>

          <div class="form-row">
            <div class="form-col">
              <ion-item class="form-item time-picker">
                <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
                <ion-label position="floating">Hora de inicio <ion-text color="danger">*</ion-text></ion-label>
                <ion-input type="time" [(ngModel)]="capacitacion.Hora_Inicio" name="Hora_Inicio" required #horaInicio="ngModel"></ion-input>
                <ion-icon name="alarm-outline" slot="end" color="medium" class="time-icon"></ion-icon>
              </ion-item>
              <ion-note color="danger" *ngIf="horaInicio.invalid && (horaInicio.dirty || horaInicio.touched)">
                <ion-icon name="alert-circle-outline"></ion-icon>
                La hora de inicio es obligatoria
              </ion-note>
            </div>

            <div class="form-col">
              <ion-item class="form-item time-picker">
                <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
                <ion-label position="floating">Hora de fin <ion-text color="danger">*</ion-text></ion-label>
                <ion-input type="time" [(ngModel)]="capacitacion.Hora_Fin" name="Hora_Fin" required #horaFin="ngModel"></ion-input>
                <ion-icon name="alarm-outline" slot="end" color="medium" class="time-icon"></ion-icon>
              </ion-item>
              <ion-note color="danger" *ngIf="horaFin.invalid && (horaFin.dirty || horaFin.touched)">
                <ion-icon name="alert-circle-outline"></ion-icon>
                La hora de fin es obligatoria
              </ion-note>
            </div>
          </div>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Lugar <ion-text color="danger">*</ion-text></ion-label>
              <ion-input [(ngModel)]="capacitacion.Lugar_Capacitacion" name="Lugar_Capacitacion" required #lugar="ngModel"></ion-input>
            </ion-item>
            <ion-note color="danger" *ngIf="lugar.invalid && (lugar.dirty || lugar.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              El lugar es obligatorio
            </ion-note>
          </div>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="laptop-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Modalidad <ion-text color="danger">*</ion-text></ion-label>
              <ion-select [(ngModel)]="capacitacion.Modalidades" name="Modalidades" required interface="action-sheet" #modalidad="ngModel" (ionChange)="onModalidadChange()">
                <ion-select-option value="Virtual">Virtual</ion-select-option>
                <ion-select-option value="Hibrida">Híbrida</ion-select-option>
                <ion-select-option value="Presencial">Presencial</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-note color="danger" *ngIf="modalidad.invalid && (modalidad.dirty || modalidad.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              La modalidad es obligatoria
            </ion-note>
          </div>

          <!-- Campo para enlace de reunión virtual -->
          <div class="form-group virtual-link-group" *ngIf="capacitacion.Modalidades === 'Virtual' || capacitacion.Modalidades === 'Hibrida'">
            <ion-item class="form-item">
              <ion-icon name="link-outline" slot="start" color="primary"></ion-icon>
              <ion-label position="floating">Enlace de Reunión Virtual <ion-text color="danger" *ngIf="capacitacion.Modalidades === 'Virtual'">*</ion-text></ion-label>
              <ion-input [(ngModel)]="capacitacion.Enlace_Virtual" name="Enlace_Virtual" [required]="capacitacion.Modalidades === 'Virtual'" #enlaceVirtual="ngModel" placeholder="https://zoom.us/j/..."></ion-input>
              <ion-icon name="open-outline" slot="end" color="tertiary" class="link-icon" *ngIf="capacitacion.Enlace_Virtual" (click)="abrirEnlace(capacitacion.Enlace_Virtual)"></ion-icon>
            </ion-item>
            <ion-note color="danger" *ngIf="enlaceVirtual.invalid && (enlaceVirtual.dirty || enlaceVirtual.touched) && capacitacion.Modalidades === 'Virtual'">
              <ion-icon name="alert-circle-outline"></ion-icon>
              El enlace de reunión es obligatorio para modalidad virtual
            </ion-note>
            <ion-note color="medium" *ngIf="capacitacion.Modalidades === 'Virtual' || capacitacion.Modalidades === 'Hibrida'">
              <ion-icon name="information-circle-outline"></ion-icon>
              Añada un enlace a Zoom, Teams, Google Meet u otra plataforma
            </ion-note>
          </div>

          <div class="form-row">
            <div class="form-col">
              <ion-item class="form-item">
                <ion-icon name="hourglass-outline" slot="start" color="primary"></ion-icon>
                <ion-label position="floating">Duración (horas) <ion-text color="danger">*</ion-text></ion-label>
                <ion-input type="number" [(ngModel)]="capacitacion.Horas" name="Horas" required min="1" #horas="ngModel"></ion-input>
              </ion-item>
              <ion-note color="danger" *ngIf="horas.invalid && (horas.dirty || horas.touched)">
                <ion-icon name="alert-circle-outline"></ion-icon>
                El número de horas es obligatorio
              </ion-note>
            </div>

            <div class="form-col">
              <ion-item class="form-item">
                <ion-icon name="people-outline" slot="start" color="primary"></ion-icon>
                <ion-label position="floating">Límite de Participantes <ion-text color="danger">*</ion-text></ion-label>
                <ion-input type="number" [(ngModel)]="capacitacion.Limite_Participantes" name="Limite_Participantes" required min="1" #limiteParticipantes="ngModel"></ion-input>
              </ion-item>
              <ion-note color="danger" *ngIf="limiteParticipantes.invalid && (limiteParticipantes.dirty || limiteParticipantes.touched)">
                <ion-icon name="alert-circle-outline"></ion-icon>
                El límite de participantes es obligatorio
              </ion-note>
            </div>
          </div>
        </div>

        <!-- Sección de Responsables y Entidades -->
        <div class="form-section">
          <h3 class="section-title">
            <ion-icon name="people-outline"></ion-icon>
            Responsables y Entidades
          </h3>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Responsables/Expositores <ion-text color="danger">*</ion-text></ion-label>
              <ion-select [(ngModel)]="capacitacion.expositores" name="expositores" multiple="true" required #expositoresModel="ngModel" interface="action-sheet">
                <ion-select-option *ngFor="let usuario of usuarios" [value]="usuario.Id_Usuario">
                  {{ usuario.Nombre_Usuario }} {{ usuario.Firma_Usuario ? '(con firma)' : '(sin firma)' }}
                </ion-select-option>
              </ion-select>
            </ion-item>
            <ion-note color="danger" *ngIf="expositoresModel.invalid && (expositoresModel.dirty || expositoresModel.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              Debe seleccionar al menos un responsable/expositor
            </ion-note>
            <ion-note color="medium">
              <ion-icon name="information-circle-outline"></ion-icon>
              Los responsables seleccionados aparecerán en el certificado con sus firmas (si las tienen)
            </ion-note>
          </div>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Entidades Organizadoras <ion-text color="danger">*</ion-text></ion-label>
              <ion-select [(ngModel)]="capacitacion.entidades_encargadas" name="entidades_encargadas" multiple="true" required #entidadesModel="ngModel" interface="action-sheet">
                <ion-select-option *ngFor="let entidad of entidades" [value]="entidad.Id_Entidad">
                  {{ entidad.Nombre_Entidad }} {{ entidad.Imagen_Entidad ? '(con logo)' : '(sin logo)' }}
                </ion-select-option>
              </ion-select>
            </ion-item>
            <ion-note color="danger" *ngIf="entidadesModel.invalid && (entidadesModel.dirty || entidadesModel.touched)">
              <ion-icon name="alert-circle-outline"></ion-icon>
              Este campo es requerido
            </ion-note>
            <ion-note color="medium">
              <ion-icon name="information-circle-outline"></ion-icon>
              Los logos de las entidades seleccionadas aparecerán en el certificado
            </ion-note>
          </div>
        </div>

        <!-- Sección de Participantes (Opcional) -->
        <div class="form-section">
          <h3 class="section-title">
            <ion-icon name="people-outline"></ion-icon>
            Participantes (Opcional)
          </h3>

          <div class="form-group">
            <ion-item class="form-item">
              <ion-icon name="people-outline" slot="start" color="primary"></ion-icon>
              <ion-label>Usuarios Participantes</ion-label>
              <ion-select [(ngModel)]="capacitacion.ids_usuarios" name="ids_usuarios" multiple="true" #usuariosModel="ngModel" interface="action-sheet">
                <ion-select-option *ngFor="let usuario of usuariosDisponibles" [value]="usuario.Id_Usuario">
                  {{ usuario.Nombre_Usuario }}
                </ion-select-option>
              </ion-select>
            </ion-item>
            <ion-note color="medium">
              <ion-icon name="information-circle-outline"></ion-icon>
              Los participantes seleccionados serán automáticamente añadidos a la capacitación
            </ion-note>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="form-actions">
          <ion-button type="button" color="medium" (click)="cancelarCreacion()" fill="outline">
            <ion-icon name="close-outline" slot="start"></ion-icon>
            Cancelar
          </ion-button>

          <ion-button type="submit" color="primary" [disabled]="!capacitacionForm.valid">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar Capacitación
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>
