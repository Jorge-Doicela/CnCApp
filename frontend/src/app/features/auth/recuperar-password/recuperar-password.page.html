<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button default-href="/login"></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Recuperar Contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="recovery-container">
    <div class="logo-container ion-text-center fade-in">
      <img src="../../../../assets/cnc.png" alt="Logo CNC" class="logo">
      <h2 class="ion-text-center">Recuperar contraseña</h2>
      <p class="ion-text-center subtitle">Le enviaremos un enlace para restablecer su contraseña</p>
    </div>

    <!-- Vista de solicitud de correo -->
    <div *ngIf="paso === 'email'" class="form-container fade-in" style="animation-delay: 0.2s">
      <ion-card class="recovery-card">
        <ion-card-content>
          <ion-item class="ion-margin-bottom form-item">
            <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
            <ion-label position="floating">Correo Electrónico</ion-label>
            <ion-input [(ngModel)]="email" type="email" required="true" inputmode="email"></ion-input>
          </ion-item>

          <ion-button expand="block" color="primary" class="ion-margin-top recovery-button" (click)="solicitarRecuperacion()" [disabled]="enviando || !email">
            <ion-icon name="paper-plane-outline" slot="start"></ion-icon>
            {{ enviando ? 'Enviando...' : 'Enviar enlace de recuperación' }}
            <ion-spinner name="crescent" *ngIf="enviando"></ion-spinner>
          </ion-button>

          <div class="back-to-login ion-text-center ion-margin-top">
            <ion-button fill="clear" size="small" color="medium" routerLink="/login">
              Volver a inicio de sesión
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Información adicional -->
      <div class="info-card fade-in" style="animation-delay: 0.4s">
        <ion-icon name="information-circle-outline" color="primary"></ion-icon>
        <div class="info-text">
          <h4>¿No recibió el correo?</h4>
          <p>Verifique su carpeta de spam o correo no deseado. Si el problema persiste, contacte al administrador.</p>
        </div>
      </div>
    </div>

    <!-- Vista de actualización de contraseña (se muestra cuando hay un token en la URL) -->
    <div *ngIf="paso === 'resetear'" class="form-container fade-in" style="animation-delay: 0.2s">
      <ion-card class="recovery-card">
        <ion-card-content>
          <ion-item class="ion-margin-bottom form-item">
            <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
            <ion-label position="floating">Nueva Contraseña</ion-label>
            <ion-input [(ngModel)]="nuevaContrasena" type="password" required="true"></ion-input>
          </ion-item>

          <ion-item class="ion-margin-bottom form-item">
            <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
            <ion-label position="floating">Confirmar Contraseña</ion-label>
            <ion-input [(ngModel)]="confirmarContrasena" type="password" required="true"></ion-input>
          </ion-item>

          <ion-button expand="block" color="primary" class="ion-margin-top recovery-button" (click)="actualizarContrasena()" [disabled]="enviando || !nuevaContrasena || !confirmarContrasena">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            {{ enviando ? 'Actualizando...' : 'Actualizar contraseña' }}
            <ion-spinner name="crescent" *ngIf="enviando"></ion-spinner>
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Validación de contraseña -->
      <div class="password-validation fade-in" style="animation-delay: 0.4s" *ngIf="nuevaContrasena">
        <h4>La contraseña debe tener:</h4>
        <div class="validation-item" [ngClass]="{'valid': nuevaContrasena.length >= 8}">
          <ion-icon [name]="nuevaContrasena.length >= 8 ? 'checkmark-circle' : 'close-circle'" [color]="nuevaContrasena.length >= 8 ? 'success' : 'medium'"></ion-icon>
          Al menos 8 caracteres
        </div>
        <div class="validation-item" [ngClass]="{'valid': hasUpperCase(nuevaContrasena)}">
          <ion-icon [name]="hasUpperCase(nuevaContrasena) ? 'checkmark-circle' : 'close-circle'"
                    [color]="hasUpperCase(nuevaContrasena) ? 'success' : 'medium'"></ion-icon>
          Al menos una letra mayúscula
        </div>
        <div class="validation-item" [ngClass]="{'valid': hasLowerCase(nuevaContrasena)}">
          <ion-icon [name]="hasLowerCase(nuevaContrasena) ? 'checkmark-circle' : 'close-circle'"
                    [color]="hasLowerCase(nuevaContrasena) ? 'success' : 'medium'"></ion-icon>
          Al menos una letra minúscula
        </div>
        <div class="validation-item" [ngClass]="{'valid': hasDigit(nuevaContrasena)}">
          <ion-icon [name]="hasDigit(nuevaContrasena) ? 'checkmark-circle' : 'close-circle'"
                    [color]="hasDigit(nuevaContrasena) ? 'success' : 'medium'"></ion-icon>
          Al menos un número
        </div>
        <div class="validation-item" [ngClass]="{'valid': nuevaContrasena === confirmarContrasena && confirmarContrasena !== ''}">
          <ion-icon [name]="nuevaContrasena === confirmarContrasena && confirmarContrasena !== '' ? 'checkmark-circle' : 'close-circle'" [color]="nuevaContrasena === confirmarContrasena && confirmarContrasena !== '' ? 'success' : 'danger'"></ion-icon>
          Las contraseñas coinciden
        </div>
      </div>
    </div>

    <!-- Vista de éxito -->
    <div *ngIf="paso === 'exito'" class="success-container fade-in">
      <div class="success-icon">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
      </div>
      <h3>¡Contraseña actualizada!</h3>
      <p>Su contraseña ha sido actualizada exitosamente. Ya puede iniciar sesión con sus nuevas credenciales.</p>
      <ion-button expand="block" color="primary" routerLink="/login">
        Ir al inicio de sesión
      </ion-button>
    </div>
  </div>
</ion-content>
