<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/gestionar-capacitaciones"></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center">Gestión de Participantes</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card class="main-card">
    <div class="logo-container ion-text-center">
      <img src="../../../../assets/cnc.png" alt="Logo Capacitaciones" class="logo">
    </div>

    <div *ngIf="cargando" class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando participantes...</p>
    </div>

    <ion-card-content *ngIf="!cargando">
      <!-- Detalles de la capacitación -->
      <div class="capacitacion-section fade-in" *ngIf="infoCapacitacion">
        <h3 class="section-title">Detalles de la Capacitación</h3>
        <div class="capacitacion-card">
          <div class="capacitacion-header" [ngClass]="{
            'header-pending': infoCapacitacion.estado === 'Activa',
            'header-completed': infoCapacitacion.estado === 'Finalizada',
            'header-canceled': infoCapacitacion.estado === 'Cancelada'
          }">
            <h2>{{ infoCapacitacion.nombre }}</h2>
            <span class="capacitacion-badge" [ngClass]="{
              'badge-pending': infoCapacitacion.estado === 'Activa',
              'badge-completed': infoCapacitacion.estado === 'Finalizada',
              'badge-canceled': infoCapacitacion.estado === 'Cancelada'
            }">
              {{ getEstadoTexto(infoCapacitacion.estado) }}
            </span>
          </div>

          <div class="capacitacion-content">
            <p class="capacitacion-description">{{ infoCapacitacion.descripcion }}</p>

            <div class="capacitacion-details">
              <div class="detail-item">
                <ion-icon name="calendar-outline" color="primary"></ion-icon>
                <span>{{ infoCapacitacion.fechaInicio | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>

              <div class="detail-item">
                <ion-icon name="location-outline" color="primary"></ion-icon>
                <span>{{ infoCapacitacion.lugar }}</span>
              </div>

              <div class="detail-item">
                <ion-icon name="time-outline" color="primary"></ion-icon>
                <span>{{ infoCapacitacion.horas }} horas</span>
              </div>

              <div class="detail-item">
                <ion-icon name="people-outline" color="primary"></ion-icon>
                <span>{{ usuariosInscritos.length }} / {{ infoCapacitacion.limiteParticipantes }} participantes</span>
              </div>

              <!-- Mostrar enlace de reunión virtual -->
              <div class="detail-item" *ngIf="infoCapacitacion.enlaceVirtual">
                <ion-icon name="link-outline" color="primary"></ion-icon>
                <a [href]="infoCapacitacion.enlaceVirtual" target="_blank" class="virtual-link">
                  Enlace de reunión virtual
                  <ion-icon name="open-outline" size="small"></ion-icon>
                </a>
              </div>

              <div class="detail-item" *ngIf="infoCapacitacion.certificado">
                <ion-icon name="ribbon-outline" color="warning"></ion-icon>
                <span>Certificado Emitido</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Entidades Organizadoras -->
      <div class="entidades-section fade-in" style="animation-delay: 0.05s;" *ngIf="entidadesEncargadas.length > 0">
        <h3 class="section-title">
          <ion-icon name="business-outline"></ion-icon>
          Entidades Organizadoras
        </h3>
        <div class="entidades-grid">
          <div class="entidad-card" *ngFor="let entidad of entidadesEncargadas">
            <div class="entidad-header">
              <ion-icon name="business"></ion-icon>
              <h4>{{ entidad.Nombre_Entidad }}</h4>
            </div>
            <p *ngIf="entidad.Descripcion_Entidad" class="entidad-description">
              {{ entidad.Descripcion_Entidad }}
            </p>
          </div>
        </div>
      </div>

      <!-- Sección de Expositores -->
      <div class="expositores-section fade-in" style="animation-delay: 0.1s;" *ngIf="expositores.length > 0">
        <h3 class="section-title">
          <ion-icon name="people-outline"></ion-icon>
          Expositores/Responsables
        </h3>
        <div class="expositores-grid">
          <div class="expositor-card" *ngFor="let expositor of expositores">
            <div class="expositor-header">
              <div class="expositor-avatar">
                <ion-icon name="person-circle"></ion-icon>
              </div>
              <div class="expositor-info">
                <h4>{{ expositor.Nombre_Usuario }}</h4>
                <span class="expositor-badge">Expositor</span>
              </div>
            </div>
            <div class="expositor-details" *ngIf="expositor.Email || expositor.Cargo || expositor.Entidad">
              <div class="detail-item" *ngIf="expositor.Email && expositor.Email !== '-'">
                <ion-icon name="mail-outline" color="primary"></ion-icon>
                <span>{{ expositor.Email }}</span>
              </div>
              <div class="detail-item" *ngIf="expositor.Cargo && expositor.Cargo !== '-'">
                <ion-icon name="briefcase-outline" color="primary"></ion-icon>
                <span>{{ expositor.Cargo }}</span>
              </div>
              <div class="detail-item" *ngIf="expositor.Entidad && expositor.Entidad !== '-'">
                <ion-icon name="business-outline" color="primary"></ion-icon>
                <span>{{ expositor.Entidad }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas -->
      <div class="stats-section fade-in" style="animation-delay: 0.2s;">
        <h3 class="section-title">Estadísticas de Asistencia</h3>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="people-outline" color="primary"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ usuariosInscritos.length }}</span>
              <span class="stat-label">Total Inscritos</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ obtenerTotalAsistentes() }}</span>
              <span class="stat-label">Asistentes</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="close-circle-outline" color="danger"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ usuariosInscritos.length - obtenerTotalAsistentes() }}</span>
              <span class="stat-label">Ausentes</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <ion-icon name="analytics-outline" color="tertiary"></ion-icon>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{ usuariosInscritos.length > 0 ? (obtenerTotalAsistentes() /
                usuariosInscritos.length * 100).toFixed(0) : 0 }}%</span>
              <span class="stat-label">Asistencia</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Buscador y filtros -->
      <div class="search-section fade-in" style="animation-delay: 0.3s;">
        <h3 class="section-title">Gestión de Participantes</h3>
        <div class="search-container">
          <ion-item class="search-item">
            <ion-icon name="search-outline" slot="start" color="primary"></ion-icon>
            <ion-input placeholder="Buscar participante por nombre o rol" [(ngModel)]="terminoBusqueda"
              (ionChange)="filtrarParticipantes()"></ion-input>
          </ion-item>

          <div class="filter-container">
            <ion-segment [(ngModel)]="filtroAsistencia" (ionChange)="filtrarParticipantes()" class="filter-segment">
              <ion-segment-button value="todos">
                <ion-label>Todos</ion-label>
              </ion-segment-button>
              <ion-segment-button value="asistentes">
                <ion-label>Asistentes</ion-label>
              </ion-segment-button>
              <ion-segment-button value="ausentes">
                <ion-label>Ausentes</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <ion-button expand="block" color="primary" (click)="marcarTodosAsistieron()"
            *ngIf="!infoCapacitacion?.certificado" class="action-button">
            <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
            Marcar a todos como asistentes
          </ion-button>
        </div>
      </div>

      <!-- Lista de participantes -->
      <div class="participants-section fade-in" style="animation-delay: 0.4s;">
        <div class="section-header">
          <h3 class="section-title">Listado de Participantes</h3>
          <span class="results-count">{{ participantesFiltrados.length }} registros</span>
        </div>

        <div *ngIf="participantesFiltrados.length === 0" class="empty-state">
          <ion-icon name="people"></ion-icon>
          <h3>No hay participantes</h3>
          <p *ngIf="terminoBusqueda">No se encontraron participantes que coincidan con "{{ terminoBusqueda }}"</p>
          <p *ngIf="!terminoBusqueda">Aún no hay participantes inscritos en esta capacitación</p>
          <ion-button expand="block" color="primary" (click)="limpiarFiltros()"
            *ngIf="terminoBusqueda || filtroAsistencia !== 'todos'" class="action-button">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Limpiar filtros
          </ion-button>
        </div>

        <div class="participants-grid" *ngIf="participantesFiltrados.length > 0">
          <div class="participant-card" *ngFor="let usuario of participantesFiltrados"
            [ngClass]="{'attended-card': usuario.Asistencia, 'absent-card': !usuario.Asistencia}">
            <div class="participant-header">
              <div class="participant-avatar">
                <ion-icon name="person-circle"></ion-icon>
              </div>
              <div class="participant-info">
                <h4>{{ usuario.Nombre_Usuario }}</h4>
                <span class="participant-badge"
                  [ngClass]="{'badge-attended': usuario.Asistencia, 'badge-absent': !usuario.Asistencia}">
                  {{ usuario.Asistencia ? 'Asistió' : 'No asistió' }}
                </span>
              </div>
            </div>

            <div class="participant-content">
              <div class="participant-detail">
                <ion-icon name="briefcase-outline" color="primary"></ion-icon>
                <span>{{ usuario.Rol_Capacitacion || 'Participante' }}</span>
              </div>

              <!-- Mostrar información adicional si está disponible -->
              <div class="participant-detail" *ngIf="usuario.Email && usuario.Email !== '-'">
                <ion-icon name="mail-outline" color="primary"></ion-icon>
                <span>{{ usuario.Email }}</span>
              </div>

              <div class="participant-detail" *ngIf="usuario.Cargo && usuario.Cargo !== '-'">
                <ion-icon name="briefcase-outline" color="primary"></ion-icon>
                <span>{{ usuario.Cargo }}</span>
              </div>

              <div class="participant-detail" *ngIf="usuario.Entidad && usuario.Entidad !== '-'">
                <ion-icon name="business-outline" color="primary"></ion-icon>
                <span>{{ usuario.Entidad }}</span>
              </div>
            </div>

            <div class="participant-actions">
              <ion-toggle [(ngModel)]="usuario.Asistencia" (ionChange)="actualizarAsistencia(usuario)"
                [disabled]="infoCapacitacion?.Certificado">
              </ion-toggle>

              <ion-button fill="clear" color="danger" (click)="confirmarEliminar(usuario)"
                *ngIf="!infoCapacitacion?.Certificado">
                <ion-icon name="trash-outline"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de certificados -->
      <div class="certificate-section fade-in" style="animation-delay: 0.5s;"
        *ngIf="infoCapacitacion && infoCapacitacion.Estado === 1 && !infoCapacitacion.Certificado">
        <h3 class="section-title">
          <ion-icon name="ribbon-outline"></ion-icon>
          Emisión de Certificados
        </h3>
        <div class="certificate-card">
          <div class="certificate-content">
            <p>Emita los certificados para todos los participantes que asistieron a esta capacitación.</p>

            <div class="certificate-alert">
              <ion-icon name="warning-outline" color="warning"></ion-icon>
              <p>Al emitir los certificados, los participantes marcados como "No asistieron" serán eliminados
                permanentemente.</p>
            </div>

            <ion-button expand="block" color="warning" (click)="mostrarConfirmacion()"
              [disabled]="obtenerTotalAsistentes() === 0" class="action-button">
              <ion-icon name="ribbon" slot="start"></ion-icon>
              Emitir certificados
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Certificado generado -->
      <div class="certificate-section fade-in" style="animation-delay: 0.5s;"
        *ngIf="infoCapacitacion && infoCapacitacion.Certificado">
        <h3 class="section-title">
          <ion-icon name="ribbon"></ion-icon>
          Certificados Emitidos
        </h3>
        <div class="certificate-card generated">
          <div class="certificate-preview">
            <div class="certificate-header">
              <ion-icon name="ribbon"></ion-icon>
              <h4>Certificado de Participación</h4>
            </div>
            <div class="certificate-body">
              <p>Se certifica que los participantes asistieron a la capacitación:</p>
              <h5>{{ infoCapacitacion.nombre }}</h5>
              <p>Realizada el {{ infoCapacitacion.fechaInicio | date:'dd/MM/yyyy' }} en {{ infoCapacitacion.lugar }}<br>
                Con una duración de {{ infoCapacitacion.horas }} horas.</p>
            </div>
            <div class="certificate-footer">
              <p>Total de certificados emitidos: {{ obtenerTotalAsistentes() }}</p>
            </div>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botón de agregar participante -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!infoCapacitacion?.Certificado">
    <ion-fab-button color="primary" (click)="agregarParticipante()">
      <ion-icon name="person-add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>