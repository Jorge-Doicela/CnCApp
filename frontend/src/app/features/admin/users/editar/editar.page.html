<ion-content>
  <div class="main-container">

    <!-- Back Nav -->
    <div class="page-back-nav">
      <ion-button fill="clear" color="medium" size="small" routerLink="/gestionar-usuarios">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Gestión de Usuarios
      </ion-button>
    </div>

    <!-- Header Section -->
    <div class="header-section fade-in">
      <div class="admin-header">
        <h1>{{ usuario.nombre || 'Editar Usuario' }}</h1>
        <p>Cédula: {{ usuario.ci }} &mdash; Actualiza los datos del perfil</p>
      </div>
    </div>

    <!-- Navigation Segments -->
    <ion-segment [(ngModel)]="segmentoActual" mode="md" class="custom-segment fade-in">
      <ion-segment-button value="personal">
        <ion-icon name="person-outline"></ion-icon>
        <ion-label>Personal</ion-label>
      </ion-segment-button>
      <ion-segment-button value="ubicacion">
        <ion-icon name="location-outline"></ion-icon>
        <ion-label>Ubicación</ion-label>
      </ion-segment-button>
      <ion-segment-button value="sistema">
        <ion-icon name="shield-checkmark-outline"></ion-icon>
        <ion-label>Sistema</ion-label>
      </ion-segment-button>
    </ion-segment>

    <div class="form-content fade-in" [ngSwitch]="segmentoActual">

      <!-- Pestaña Personal -->
      <div *ngSwitchCase="'personal'" class="tab-content">
        <div class="form-card">
          <h3 class="section-title">
            <ion-icon name="id-card-outline"></ion-icon>
            Identificación y Nombres
          </h3>

          <div class="field-group">
            <ion-item class="form-field ion-margin-bottom">
              <ion-label position="stacked">Cédula (No editable)</ion-label>
              <ion-input [(ngModel)]="usuario.ci" readonly placeholder="Cédula"></ion-input>
              <ion-icon name="lock-closed-outline" slot="end" size="small"></ion-icon>
            </ion-item>

            <ion-item class="form-field ion-margin-bottom">
              <ion-label position="stacked">Correo Electrónico</ion-label>
              <ion-input [(ngModel)]="usuario.email" type="email" placeholder="email@ejemplo.com"></ion-input>
              <ion-icon name="mail-outline" slot="start"></ion-icon>
            </ion-item>
          </div>

          <div class="field-group">
            <ion-item class="form-field">
              <ion-label position="stacked">Primer Nombre *</ion-label>
              <ion-input [(ngModel)]="usuario.nombre1" placeholder="Ej: Juan"></ion-input>
            </ion-item>
            <ion-item class="form-field">
              <ion-label position="stacked">Segundo Nombre</ion-label>
              <ion-input [(ngModel)]="usuario.nombre2" placeholder="Ej: Antonio"></ion-input>
            </ion-item>
          </div>

          <div class="field-group">
            <ion-item class="form-field">
              <ion-label position="stacked">Primer Apellido *</ion-label>
              <ion-input [(ngModel)]="usuario.apellido1" placeholder="Ej: Pérez"></ion-input>
            </ion-item>
            <ion-item class="form-field">
              <ion-label position="stacked">Segundo Apellido</ion-label>
              <ion-input [(ngModel)]="usuario.apellido2" placeholder="Ej: Castro"></ion-input>
            </ion-item>
          </div>

          <h3 class="section-title ion-margin-top">
            <ion-icon name="call-outline"></ion-icon>
            Contacto y Adicionales
          </h3>

          <div class="field-group triple">
            <ion-item class="form-field">
              <ion-label position="stacked">Celular</ion-label>
              <ion-input [(ngModel)]="usuario.celular" type="tel" placeholder="099..."></ion-input>
            </ion-item>
            <ion-item class="form-field">
              <ion-label position="stacked">Convencional</ion-label>
              <ion-input [(ngModel)]="usuario.convencional" type="tel" placeholder="02..."></ion-input>
            </ion-item>
            <ion-item class="form-field">
              <ion-label position="stacked">Género</ion-label>
              <ion-select [(ngModel)]="usuario.genero" interface="popover">
                <ion-select-option value="Masculino">Masculino</ion-select-option>
                <ion-select-option value="Femenino">Femenino</ion-select-option>
                <ion-select-option value="Otro">Otro</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <div class="field-group">
            <ion-item class="form-field">
              <ion-label position="stacked">Fecha de Nacimiento</ion-label>
              <ion-input type="date" [(ngModel)]="usuario.fechaNacimiento"></ion-input>
            </ion-item>
            <ion-item class="form-field">
              <ion-label position="stacked">Etnia</ion-label>
              <ion-select [(ngModel)]="usuario.etnia" interface="popover">
                <ion-select-option value="MESTIZO">Mestizo</ion-select-option>
                <ion-select-option value="AFROECUATORIANO">Afroecuatoriano</ion-select-option>
                <ion-select-option value="INDÍGENA">Indígena</ion-select-option>
                <ion-select-option value="MONTUBIO">Montubio</ion-select-option>
                <ion-select-option value="OTRO">Otro</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

        </div>
      </div>

      <!-- Pestaña Ubicación -->
      <div *ngSwitchCase="'ubicacion'" class="tab-content">
        <div class="form-card">
          <h3 class="section-title">
            <ion-icon name="globe-outline"></ion-icon>
            Residencia Geográfica
          </h3>
          <p class="section-description">Actualice la ubicación donde reside actualmente el usuario.</p>

          <div class="field-group">
            <ion-item class="form-field">
              <ion-label position="stacked">Provincia</ion-label>
              <ion-select [(ngModel)]="datosbusqueda.selectedProvincia" (ionChange)="cambioProvincia()"
                placeholder="Seleccione Provincia">
                <ion-select-option *ngFor="let prov of datosrecuperados.provincias" [value]="prov.id">
                  {{ prov.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-field">
              <ion-label position="stacked">Cantón</ion-label>
              <ion-select [(ngModel)]="usuario.cantonReside" (ionChange)="cambioCanton()"
                placeholder="Seleccione Cantón" [disabled]="!datosbusqueda.selectedProvincia">
                <ion-select-option *ngFor="let cant of datosrecuperados.cantones" [value]="cant.id">
                  {{ cant.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <ion-item class="form-field ion-margin-top">
            <ion-label position="stacked">Parroquia</ion-label>
            <ion-select [(ngModel)]="usuario.parroquiaReside" placeholder="Seleccione Parroquia"
              [disabled]="!usuario.cantonReside">
              <ion-select-option *ngFor="let parr of datosrecuperados.parroquias" [value]="parr.id">
                {{ parr.nombre }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Pestaña Sistema -->
      <div *ngSwitchCase="'sistema'" class="tab-content">
        <div class="form-card">
          <h3 class="section-title">
            <ion-icon name="settings-outline"></ion-icon>
            Configuración de Cuenta y Rol
          </h3>

          <div class="field-group">
            <ion-item class="form-field">
              <ion-label position="stacked">Rol de Sistema *</ion-label>
              <ion-select [(ngModel)]="usuario.rolId" interface="popover">
                <ion-select-option *ngFor="let r of datosrecuperados.roles" [value]="r.id">
                  {{ r.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-field">
              <ion-label position="stacked">Estado de Cuenta</ion-label>
              <ion-select [(ngModel)]="usuario.estado" interface="popover">
                <ion-select-option [value]="1">Activo / Habilitado</ion-select-option>
                <ion-select-option [value]="0">Inactivo / Bloqueado</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <h3 class="section-title ion-margin-top">
            <ion-icon name="briefcase-outline"></ion-icon>
            Tipo de Participante
          </h3>

          <ion-item class="form-field ion-margin-bottom">
            <ion-label position="stacked">Categoría de Usuario</ion-label>
            <ion-select [(ngModel)]="usuario.tipoParticipante" interface="popover">
              <ion-select-option [value]="0">Ciudadano / Particular</ion-select-option>
              <ion-select-option [value]="1">Autoridad</ion-select-option>
              <ion-select-option [value]="2">Funcionario GAD</ion-select-option>
              <ion-select-option [value]="3">Institución del Sistema</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Dynamic Fields Based on Participant Type -->
          <div [ngSwitch]="usuario.tipoParticipante" class="animate-in">
            <!-- Autoridad -->
            <div *ngSwitchCase="1" class="specific-fields card-inner">
              <div class="field-group">
                <ion-item class="form-field">
                  <ion-label position="stacked">Cargo Autoridad</ion-label>
                  <ion-select [(ngModel)]="autoridad.cargo">
                    <ion-select-option *ngFor="let c of datosrecuperados.cargos" [value]="c.nombre">
                      {{ c.nombre }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
                <ion-item class="form-field">
                  <ion-label position="stacked">Nivel Gobierno</ion-label>
                  <ion-select [(ngModel)]="autoridad.nivelgobierno">
                    <ion-select-option value="PROVINCIAL">Provincial</ion-select-option>
                    <ion-select-option value="CANTONAL">Cantonal</ion-select-option>
                    <ion-select-option value="PARROQUIAL">Parroquial</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </div>

            <!-- Funcionario -->
            <div *ngSwitchCase="2" class="specific-fields card-inner">
              <div class="field-group">
                <ion-item class="form-field">
                  <ion-label position="stacked">Cargo Funcionario</ion-label>
                  <ion-select [(ngModel)]="funcionarioGad.cargo">
                    <ion-select-option *ngFor="let c of datosrecuperados.cargos" [value]="c.nombre">
                      {{ c.nombre }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
                <ion-item class="form-field">
                  <ion-label position="stacked">Nivel Gobierno</ion-label>
                  <ion-select [(ngModel)]="funcionarioGad.nivelgobierno">
                    <ion-select-option value="PROVINCIAL">Provincial</ion-select-option>
                    <ion-select-option value="CANTONAL">Cantonal</ion-select-option>
                    <ion-select-option value="PARROQUIAL">Parroquial</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </div>

            <!-- Institucion -->
            <div *ngSwitchCase="3" class="specific-fields card-inner">
              <div class="field-group">
                <ion-item class="form-field">
                  <ion-label position="stacked">Institución</ion-label>
                  <ion-select [(ngModel)]="institucion.institucion">
                    <ion-select-option *ngFor="let inst of datosrecuperados.instituciones" [value]="inst.id">
                      {{ inst.nombre }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
                <ion-item class="form-field">
                  <ion-label position="stacked">Cargo Institucional</ion-label>
                  <ion-input [(ngModel)]="institucion.cargo" placeholder="Ej: Especialista"></ion-input>
                </ion-item>
              </div>
            </div>
          </div>

          <h3 class="section-title ion-margin-top">
            <ion-icon name="create-outline"></ion-icon>
            Firma Digital
          </h3>
          <div class="firma-container">
            <div class="firma-preview" *ngIf="usuario.firmaUrl">
              <img [src]="usuario.firmaUrl" alt="Firma" class="firma-image">
              <ion-button size="small" color="danger" fill="clear" (click)="eliminarFirma()">
                <ion-icon name="trash-outline" slot="start"></ion-icon>Eliminar
              </ion-button>
            </div>
            <div class="firma-upload" *ngIf="!usuario.firmaUrl">
              <ion-item class="firma-dropzone" lines="none">
                <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
                <ion-label>Cargar Archivo de Firma</ion-label>
                <input type="file" (change)="seleccionarFirma($event)" accept="image/*" class='file-input'>
              </ion-item>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Final Actions -->
    <div class="form-actions fade-in">
      <ion-button fill="clear" color="medium" (click)="segmentoActual = 'personal'"
        *ngIf="segmentoActual !== 'personal'">
        Atrás
      </ion-button>
      <ion-button color="primary" (click)="actualizarUsuario()" [disabled]="cargando">
        <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
        Actualizar Usuario
      </ion-button>
    </div>

  </div>
</ion-content>