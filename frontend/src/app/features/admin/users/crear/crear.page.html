<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/gestionar-usuarios"></ion-back-button>
    </ion-buttons>
    <ion-title>Crear Nuevo Usuario</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="main-container">

    <!-- Header Section -->
    <div class="header-section fade-in">
      <h1>
        Registro de Usuario
        <span>Complete la información para dar de alta un usuario</span>
      </h1>
    </div>

    <!-- Form Card -->
    <div class="form-card fade-in" style="animation-delay: 0.1s;">

      <!-- Seccion 1: Identificación y Credenciales -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="shield-checkmark-outline"></ion-icon>
          Credenciales y Acceso
        </h3>
        <p class="section-description">Datos para el inicio de sesión y rol del usuario en la plataforma.</p>

        <div class="field-group triple">
          <!-- Cédula -->
          <div>
            <ion-item class="form-field">
              <ion-icon name="id-card-outline" slot="start"></ion-icon>
              <ion-label position="floating">Cédula (CI) *</ion-label>
              <ion-input [(ngModel)]="usuarioGeneral.ci" type="text" maxlength="10" required></ion-input>
              <ion-button slot="end" fill="clear" (click)="validarCedula()">
                <ion-icon name="checkmark-done-circle-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
            <div *ngIf="mensajeValidacionCedula"
              [ngClass]="{'validacion-error': !cedulaValidada, 'validacion-success': cedulaValidada}"
              class="mensaje-validacion">
              <ion-icon [name]="cedulaValidada ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
              {{ mensajeValidacionCedula }}
            </div>
          </div>

          <!-- Email -->
          <ion-item class="form-field">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label position="floating">Correo Electrónico *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.email" type="email" required></ion-input>
          </ion-item>

          <!-- Password -->
          <ion-item class="form-field">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-label position="floating">Contraseña *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.password" type="password" required></ion-input>
          </ion-item>
        </div>

        <div class="field-group">
          <!-- Rol -->
          <ion-item class="form-field">
            <ion-icon name="key-outline" slot="start"></ion-icon>
            <ion-label>Rol de Usuario *</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.rolId" placeholder="Seleccione Rol" interface="popover">
              <ion-select-option *ngFor="let rol of datosrecuperados.roles" [value]="rol.id">
                {{ rol.nombre_rol }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Tipo Participante -->
          <ion-item class="form-field">
            <ion-icon name="people-outline" slot="start"></ion-icon>
            <ion-label>Tipo Participante *</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.tipoParticipante" (ionChange)="onTipoParticipanteChange()"
              placeholder="Seleccione Tipo" interface="popover">
              <ion-select-option value="0">Ciudadano</ion-select-option>
              <ion-select-option value="1">Autoridad</ion-select-option>
              <ion-select-option value="2">Funcionario GAD</ion-select-option>
              <ion-select-option value="3">Institución</ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Seccion 2: Datos Personales -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="person-outline"></ion-icon>
          Información Personal
        </h3>

        <div class="field-group">
          <ion-item class="form-field">
            <ion-label position="floating">Primer Nombre *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.nombre1" [readonly]="camposNombreReadonly"></ion-input>
          </ion-item>
          <ion-item class="form-field">
            <ion-label position="floating">Segundo Nombre</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.nombre2" [readonly]="camposNombreReadonly"></ion-input>
          </ion-item>
        </div>
        <div class="field-group">
          <ion-item class="form-field">
            <ion-label position="floating">Primer Apellido *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.apellido1" [readonly]="camposNombreReadonly"></ion-input>
          </ion-item>
          <ion-item class="form-field">
            <ion-label position="floating">Segundo Apellido</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.apellido2" [readonly]="camposNombreReadonly"></ion-input>
          </ion-item>
        </div>

        <div class="field-group" *ngIf="!nombresEdited">
          <ion-button expand="block" shape="round" fill="outline" color="secondary" (click)="confirmarNombres()"
            [disabled]="!usuarioGeneral.nombre1 || !usuarioGeneral.apellido1">
            <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
            Confirmar Nombres
          </ion-button>
        </div>

        <div class="field-group triple">
          <ion-item class="form-field">
            <ion-label position="floating">Celular *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.celular" type="tel"></ion-input>
          </ion-item>
          <ion-item class="form-field">
            <ion-label position="floating">Convencional</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.convencional" type="tel"></ion-input>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Fecha Nacimiento *</ion-label>
            <ion-input [(ngModel)]="usuarioGeneral.fechaNacimiento" type="date"></ion-input>
          </ion-item>
        </div>

        <div class="field-group">
          <ion-item class="form-field">
            <ion-label>Género *</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.genero" placeholder="Seleccione" interface="popover">
              <ion-select-option value="Masculino">Masculino</ion-select-option>
              <ion-select-option value="Femenino">Femenino</ion-select-option>
              <ion-select-option value="Otro">Otro</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Etnia *</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.etnia" placeholder="Seleccione" interface="popover">
              <ion-select-option value="AFROECUATORIANO">Afroecuatoriano</ion-select-option>
              <ion-select-option value="BLANCO">Blanco</ion-select-option>
              <ion-select-option value="INDÍGENA">Indígena</ion-select-option>
              <ion-select-option value="MESTIZO">Mestizo</ion-select-option>
              <ion-select-option value="MONTUBIO">Montubio</ion-select-option>
              <ion-select-option value="OTRO">Otro</ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Seccion 3: Ubicación -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="map-outline"></ion-icon>
          Ubicación
        </h3>

        <div class="field-group triple">
          <ion-item class="form-field">
            <ion-label>Provincia *</ion-label>
            <ion-select [(ngModel)]="datosbusqueda.selectedProvincia"
              (ionChange)="obtenerCantones(datosbusqueda.selectedProvincia)" placeholder="Seleccione"
              interface="popover">
              <ion-select-option *ngFor="let provincia of datosrecuperados.provincias"
                [value]="provincia.Codigo_Provincia">
                {{ provincia.Nombre_Provincia }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Cantón *</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.cantonReside"
              (ionChange)="obtenerParroquias(usuarioGeneral.cantonReside)" placeholder="Seleccione" interface="popover"
              [disabled]="!datosrecuperados.cantones.length">
              <ion-select-option *ngFor="let canton of datosrecuperados.cantones" [value]="canton.codigo_canton">
                {{ canton.nombre_canton }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Parroquia</ion-label>
            <ion-select [(ngModel)]="usuarioGeneral.parroquiaReside" placeholder="Seleccione" interface="popover"
              [disabled]="!datosrecuperados.parroquiasSeleccionadas.length">
              <ion-select-option *ngFor="let parroquia of datosrecuperados.parroquiasSeleccionadas"
                [value]="parroquia.codigo_parroquia">
                {{ parroquia.nombre_parroquia }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Seccion 4: Datos Específicos (Dinámicos) -->
      <!-- Autoridad -->
      <div class="form-section" *ngIf="usuarioGeneral.tipoParticipante == 1">
        <h3 class="section-title">Datos Autoridad</h3>
        <div class="field-group">
          <ion-item class="form-field">
            <ion-label>Cargo *</ion-label>
            <ion-select [(ngModel)]="autoridad.cargo" placeholder="Seleccione" interface="popover">
              <ion-select-option value="alcalde">Alcalde(sa)</ion-select-option>
              <ion-select-option value="vicealcalde">Vicealcalde(sa)</ion-select-option>
              <ion-select-option value="consejal">Consejal(a)</ion-select-option>
              <ion-select-option value="prefecto">Prefecto(a)</ion-select-option>
              <ion-select-option value="viceprefecto">Viceprefecto(a)</ion-select-option>
              <ion-select-option value="presidenteparroquial">Presidente(a) Junta Parroquial</ion-select-option>
              <ion-select-option value="vocalparroquial">Vocal Junta Parroquial</ion-select-option>
              <ion-select-option value="otro">Otro</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Nivel Gobierno *</ion-label>
            <ion-select [(ngModel)]="autoridad.nivelgobierno" placeholder="Seleccione" interface="popover">
              <ion-select-option value="mancomunidad">Mancomunidad y Consorcios</ion-select-option>
              <ion-select-option value="municipal">Municipal</ion-select-option>
              <ion-select-option value="parroquial">Parroquial Rural</ion-select-option>
              <ion-select-option value="provincial">Provincial</ion-select-option>
              <ion-select-option value="otro">Otro</ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Funcionario GAD -->
      <div class="form-section" *ngIf="usuarioGeneral.tipoParticipante == 2">
        <h3 class="section-title">Datos Funcionario GAD</h3>
        <div class="field-group">
          <ion-item class="form-field">
            <ion-label>Cargo *</ion-label>
            <ion-select [(ngModel)]="funcionarioGad.cargo" placeholder="Seleccione" interface="popover">
              <ion-select-option value="asesor">Asesor(a)</ion-select-option>
              <ion-select-option value="director">Director(a)</ion-select-option>
              <ion-select-option value="jefe_dpto_unidad">Jefe Dpto</ion-select-option>
              <ion-select-option value="tecnico">Técnico</ion-select-option>
              <ion-select-option value="otro">Otro</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Nivel Gobierno *</ion-label>
            <ion-select [(ngModel)]="funcionarioGad.nivelgobierno" placeholder="Seleccione" interface="popover">
              <ion-select-option value="mancomunidad">Mancomunidad</ion-select-option>
              <ion-select-option value="municipal">Municipal</ion-select-option>
              <ion-select-option value="parroquial">Parroquial</ion-select-option>
              <ion-select-option value="provincial">Provincial</ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>

      <!-- Institución -->
      <div class="form-section" *ngIf="usuarioGeneral.tipoParticipante == 3">
        <h3 class="section-title">Datos Institucionales</h3>
        <div class="field-group">
          <ion-item class="form-field">
            <ion-label>Institución *</ion-label>
            <ion-select [(ngModel)]="institucion.institucion" placeholder="Seleccione" interface="popover">
              <ion-select-option *ngFor="let inst of datosrecuperados.instituciones" [value]="inst.id_institucion">
                {{ inst.nombre_institucion }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="form-field">
            <ion-label>Cargo *</ion-label>
            <ion-select [(ngModel)]="institucion.cargo" placeholder="Seleccione" interface="popover">
              <ion-select-option *ngFor="let cargo of datosrecuperados.cargos" [value]="cargo.id_cargo">
                {{ cargo.nombre_cargo }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>
      </div>


      <!-- Actions -->
      <div class="form-actions">
        <ion-button class="cancel-btn" fill="clear" color="medium" routerLink="/gestionar-usuarios">
          Cancelar
        </ion-button>
        <ion-button color="primary" (click)="crearUsuario()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar Usuario
        </ion-button>
      </div>

    </div>
  </div>
</ion-content>