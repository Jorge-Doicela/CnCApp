<ion-header class="ion-no-border">
    <ion-toolbar>
        <div class="header-content">
            <ion-buttons slot="start">
                <ion-menu-button color="dark"></ion-menu-button>
            </ion-buttons>
            <ion-title>Estadísticas del Sistema</ion-title>
            <ion-buttons slot="end">
                <div class="status-pill">
                    <span class="dot"></span>
                    Admin Panel
                </div>
            </ion-buttons>
        </div>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
    <div class="dashboard-wrapper">

        <!-- Compact Hero greeting (Public Style) -->
        <div class="hero-wrapper compact" *ngIf="!loading()">
            <div class="container hero-content">
                <span class="pill-label">Analítica de Datos</span>
                <h2>Panel de <span>Reportes</span></h2>
                <p>Resumen detallado de la participación y crecimiento de la plataforma.</p>
            </div>
        </div>

        <div class="container content-body">
            <!-- Loading State -->
            <div class="loading-container" *ngIf="loading()">
                <div class="spinner-box">
                    <ion-spinner name="crescent" color="primary"></ion-spinner>
                    <p>Sincronizando datos en tiempo real...</p>
                </div>
            </div>

            <!-- Error State -->
            <div class="error-container animate-fade-up" *ngIf="error()">
                <div class="error-card">
                    <ion-icon name="alert-circle-outline"></ion-icon>
                    <h3>Error de Conexión</h3>
                    <p>{{ error() }}</p>
                    <button class="primary pill" (click)="loadStats()">Reintentar Carga</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="main-stats animate-fade-up" *ngIf="!loading() && stats()">

                <!-- KPI Section -->
                <h3 class="dash-section-title">Indicadores Clave (KPIs)</h3>
                <div class="kpi-grid">
                    <app-kpi-card label="Usuarios Totales" [value]="stats()!.totalUsuarios" icon="people-outline"
                        type="primary" trendText="+12% este mes" [trendPositive]="true"></app-kpi-card>

                    <app-kpi-card label="Certificados" [value]="stats()!.totalCertificados" icon="ribbon-outline"
                        type="success" trendText="+5% este mes" [trendPositive]="true"></app-kpi-card>

                    <app-kpi-card label="Capacitaciones" [value]="stats()!.totalCapacitaciones" icon="school-outline"
                        type="warning" trendText="8 activas" trendIcon="time-outline"
                        [trendPositive]="false"></app-kpi-card>

                    <app-kpi-card label="Nuevos Registros" [value]="stats()!.usuariosRegistradosEsteMes"
                        icon="trending-up-outline" type="info" trendText="Meta: 50" trendIcon="stats-chart-outline"
                        [trendPositive]="true"></app-kpi-card>
                </div>

                <!-- Visualization Section -->
                <h3 class="dash-section-title">Análisis Visual</h3>
                <div class="charts-container">
                    <div class="chart-item wide">
                        <app-trend-chart title="Tendencias de Crecimiento"
                            subtitle="Evolución de registros y certificaciones (Últimos 6 meses)"
                            [data]="stats()!.tendencias"></app-trend-chart>
                    </div>
                    <div class="chart-item">
                        <app-roles-chart title="Distribución de Roles" subtitle="Segmentación de la comunidad"
                            [data]="stats()!.usuariosPorRol" [total]="stats()!.totalUsuarios"></app-roles-chart>
                    </div>
                </div>

                <!-- Activity Summary -->
                <h3 class="dash-section-title">Actividad Reciente</h3>
                <div class="summary-card">
                    <div class="card-header">
                        <div class="header-info">
                            <h4>Estado de Conferencias</h4>
                            <p>Resumen de capacitaciones dictadas y en curso</p>
                        </div>
                        <button class="secondary-btn" (click)="exportarPDF()">Exportar PDF</button>
                    </div>
                    <div class="summary-list">
                        <div class="summary-item">
                            <div class="item-visual">
                                <div class="icon-circle active"><ion-icon name="play-outline"></ion-icon></div>
                            </div>
                            <div class="item-data">
                                <span class="label">En ejecución</span>
                                <span class="val">{{ stats()!.capacitacionesActivas }}</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="item-visual">
                                <div class="icon-circle completed"><ion-icon name="checkmark-done-outline"></ion-icon>
                                </div>
                            </div>
                            <div class="item-data">
                                <span class="label">Completadas</span>
                                <span class="val">{{ stats()!.capacitacionesFinalizadas }}</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="item-visual">
                                <div class="icon-circle new"><ion-icon name="ribbon-outline"></ion-icon></div>
                            </div>
                            <div class="item-data">
                                <span class="label">Certificados del Mes</span>
                                <span class="val">{{ stats()!.certificadosEsteMes }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ion-content>